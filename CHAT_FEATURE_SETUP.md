# 聊天功能设置指南

## 功能概述

聊天功能允许订单的委托人和接单员在订单管理页面进行实时沟通，包括：
- 实时消息发送和接收
- 在线状态显示
- 消息已读状态
- 聊天会话管理

## 数据库设置

### 方法一：使用SQL脚本（推荐）

1. 登录到您的Supabase控制台
2. 进入SQL编辑器
3. 复制并执行 `setup_chat.sql` 文件中的所有SQL语句
4. 或者执行 `chat_schema.sql` 文件（包含更多高级功能）

### 方法二：手动创建表

如果SQL执行遇到问题，可以手动创建以下表：

1. **messages表** - 存储聊天消息
2. **chat_sessions表** - 管理聊天会话
3. **online_status表** - 跟踪用户在线状态
4. **message_attachments表** - 存储消息附件（可选）

## 前端功能

### 已实现的功能

1. **聊天窗口组件** (`src/components/ChatWindow.vue`)
   - 实时消息显示
   - 消息发送功能
   - 在线状态指示
   - 消息时间格式化

2. **订单管理集成** (`src/views/OrderManagement.vue`)
   - 在订单详情对话框中添加"联系沟通"标签页
   - 自动识别聊天对象（委托人/接单员）
   - 响应式设计支持

3. **聊天服务** (`src/services/chatService.ts`)
   - 消息发送和接收
   - 实时订阅功能
   - 在线状态管理
   - 错误处理和重试机制

### 使用方式

1. 登录系统
2. 进入"订单管理"页面
3. 点击任意订单的"查看详情"按钮
4. 切换到"联系沟通"标签页
5. 开始与对方聊天

## 技术特性

### 实时通信
- 使用Supabase的实时订阅功能
- 自动消息推送和状态更新
- 支持离线消息缓存

### 错误处理
- 网络错误自动重试（最多3次）
- 优雅的降级处理
- 详细的错误日志

### 性能优化
- 消息分页加载
- 数据库索引优化
- 组件懒加载

## 故障排除

### 常见问题

1. **聊天窗口不显示**
   - 检查数据库表是否创建成功
   - 确认用户已登录
   - 查看浏览器控制台错误信息

2. **消息发送失败**
   - 检查网络连接
   - 确认Supabase配置正确
   - 查看服务端错误日志

3. **实时消息不更新**
   - 检查Supabase实时订阅权限
   - 确认WebSocket连接正常
   - 验证数据库触发器是否生效

### 调试方法

1. 打开浏览器开发者工具
2. 查看Network标签页的网络请求
3. 检查Console标签页的错误信息
4. 使用Vue Devtools检查组件状态

## 扩展功能

### 计划中的功能

1. **消息类型扩展**
   - 图片消息
   - 文件传输
   - 系统通知

2. **高级功能**
   - 消息撤回
   - 聊天记录导出
   - 消息搜索

3. **用户体验优化**
   - 消息通知
   - 输入状态提示
   - 聊天记录同步

## 安全考虑

1. **数据安全**
   - 所有消息都经过Supabase认证
   - 仅订单相关用户可以访问聊天
   - 消息内容加密传输

2. **隐私保护**
   - 聊天记录仅限订单参与者可见
   - 在线状态可选择性显示
   - 消息删除功能

## 技术支持

如遇到问题，请检查：
- 数据库连接状态
- Supabase项目配置
- 网络连接状况
- 浏览器兼容性

如需进一步帮助，请提供：
- 错误日志
- 浏览器版本
- 复现步骤
- 网络环境信息