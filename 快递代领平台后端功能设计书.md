# 快递代领平台后端功能设计书

## 项目概述

基于现有快递代领平台的前端实现，本设计书详细规划后端功能架构和实现方案。平台采用 Vue 3 + TypeScript + Supabase 技术栈，已实现完整的用户端功能，现需完善后端管理功能。

## 技术架构

### 当前技术栈
- **前端框架**: Vue 3 + TypeScript
- **UI组件库**: Element Plus
- **状态管理**: Pinia
- **路由管理**: Vue Router
- **数据库**: Supabase (PostgreSQL)
- **实时通信**: Supabase Realtime
- **部署平台**: Netlify

### 后端服务架构
- **数据库层**: Supabase PostgreSQL
- **API层**: Supabase REST API + 自定义函数
- **业务逻辑层**: TypeScript Service Classes
- **认证授权**: JWT + 本地存储
- **实时通信**: WebSocket (Supabase Realtime)

## 现有功能模块分析

### 1. 用户管理模块 ✅
- **用户注册/登录** (`AuthService`)
- **用户信息管理** (`UserService`)
- **用户权限验证** (本地存储)
- **用户搜索功能** (按昵称搜索)

### 2. 订单管理模块 ✅
- **订单创建** (`OrderService.createOrder`)
- **订单查询** (全部订单、待接单订单、用户订单)
- **订单状态管理** (pending → accepted → picking → delivering → completed)
- **订单接单** (`OrderService.acceptOrder`)
- **订单状态更新** (`OrderService.updateOrderStatus`)

### 3. 支付管理模块 ✅
- **支付记录管理** (`PaymentService`)
- **支付状态跟踪** (pending → paid → confirmed)
- **支付二维码生成** (模拟微信/支付宝)
- **用户支付信息管理** (`UserPaymentService`)

### 4. 聊天通信模块 ✅
- **实时消息发送** (`ChatService.sendMessage`)
- **消息历史查询** (`ChatService.getOrderMessages`)
- **聊天会话管理** (`ChatService.getUserChatSessions`)
- **在线状态管理** (`ChatService.updateOnlineStatus`)
- **消息清理功能** (自动/手动清理)

### 5. 数据库服务模块 ✅
- **数据库连接检查** (`DatabaseService.checkConnection`)
- **示例数据初始化** (`DatabaseService.initializeSampleData`)
- **数据完整性验证**

## 后端功能设计

### 1. 用户认证与授权

#### 1.1 用户注册
```typescript
// 已实现功能
- 用户名唯一性验证
- 密码哈希存储
- 用户信息创建
- 校园信息记录
```

#### 1.2 用户登录
```typescript
// 已实现功能
- 用户名密码验证
- 会话状态管理
- 本地存储持久化
- 自动登录检查
```

#### 1.3 权限管理
```typescript
// 待完善功能
- 角色权限系统 (普通用户/管理员)
- 操作权限验证
- 数据访问控制
- API权限校验
```

### 2. 订单业务流程

#### 2.1 订单创建流程
```typescript
// 已实现流程
1. 用户填写订单信息
2. 系统生成唯一订单号
3. 验证订单数据完整性
4. 插入数据库并返回结果
5. 重试机制处理网络异常
```

#### 2.2 订单状态流转
```typescript
// 已实现状态
pending → accepted → picking → delivering → awaiting_payment → completed

// 状态对应操作
- pending: 等待接单
- accepted: 已被接单
- picking: 正在取件
- delivering: 正在配送
- awaiting_payment: 等待支付
- completed: 已完成
```

#### 2.3 订单查询优化
```typescript
// 已实现查询
- 分页查询支持
- 条件筛选 (状态、时间范围)
- 排序功能 (创建时间、价格)
- 关联用户信息查询
```

### 3. 支付系统设计

#### 3.1 支付流程
```typescript
// 已实现流程
1. 订单完成触发支付
2. 生成支付记录
3. 创建支付二维码
4. 用户扫码支付
5. 支付状态确认
6. 资金结算
```

#### 3.2 支付安全保障
```typescript
// 已实现安全措施
- 支付记录完整性验证
- 支付状态防篡改
- 交易ID唯一性
- 支付超时处理
```

#### 3.3 资金管理
```typescript
// 待完善功能
- 用户余额管理
- 交易记录审计
- 资金流向追踪
- 对账功能
```

### 4. 实时通信系统

#### 4.1 消息架构
```typescript
// 已实现功能
- 消息实时发送/接收
- 消息状态管理 (已读/未读)
- 消息类型支持 (文本/图片/系统)
- 消息历史存储
```

#### 4.2 会话管理
```typescript
// 已实现功能
- 聊天会话创建
- 会话列表维护
- 未读消息计数
- 会话状态跟踪
```

#### 4.3 在线状态
```typescript
// 已实现功能
- 用户在线状态检测
- 最后活跃时间记录
- 状态变更通知
- 离线消息处理
```

## 数据库设计

### 核心数据表结构

#### 1. 用户表 (users)
```sql
-- 已实现字段
id, username, password_hash, nickname, avatar_url, 
balance, phone, email, campus, credit_score, 
total_orders, avg_rating, created_at, updated_at
```

#### 2. 订单表 (orders)
```sql
-- 已实现字段
id, order_number, requester_id, deliverer_id,
title, express_company, tracking_number, package_description,
package_size, weight, urgent, pickup_location, delivery_location,
delivery_time, contact_phone, pickup_code, price, status,
created_at, accepted_at, picked_up_at, delivered_at, cancelled_at, updated_at
```

#### 3. 支付表 (payments)
```sql
-- 已实现字段
id, order_id, payer_id, payee_id, amount, status,
payment_method, qr_code_url, transaction_id,
created_at, paid_at, confirmed_at, updated_at
```

#### 4. 消息表 (messages)
```sql
-- 已实现字段
id, order_id, sender_id, receiver_id, content,
is_read, message_type, created_at
```

## API接口设计

### 用户相关接口
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册
- `GET /api/users/:id` - 获取用户信息
- `GET /api/users/search` - 搜索用户

### 订单相关接口
- `POST /api/orders` - 创建订单
- `GET /api/orders` - 获取订单列表
- `GET /api/orders/pending` - 获取待接单订单
- `PUT /api/orders/:id/accept` - 接单
- `PUT /api/orders/:id/status` - 更新订单状态

### 支付相关接口
- `POST /api/payments` - 创建支付记录
- `GET /api/payments/order/:orderId` - 获取订单支付信息
- `PUT /api/payments/:id/status` - 更新支付状态

### 聊天相关接口
- `POST /api/messages` - 发送消息
- `GET /api/messages/order/:orderId` - 获取订单消息
- `PUT /api/messages/read` - 标记消息已读

## 安全设计

### 1. 数据安全
- 敏感信息加密存储
- SQL注入防护
- XSS攻击防护
- CSRF防护

### 2. 业务安全
- 订单状态防篡改
- 支付金额验证
- 用户权限验证
- 操作日志记录

### 3. 通信安全
- HTTPS加密传输
- JWT令牌验证
- API访问频率限制
- 敏感操作二次验证

## 性能优化

### 1. 数据库优化
- 合理索引设计
- 查询优化
- 连接池管理
- 缓存策略

### 2. API优化
- 接口响应压缩
- 分页查询支持
- 数据懒加载
- 请求合并

### 3. 实时通信优化
- WebSocket连接复用
- 消息批量处理
- 离线消息队列
- 连接状态监控

## 监控与日志

### 1. 系统监控
- 服务可用性监控
- 性能指标监控
- 错误率监控
- 用户行为分析

### 2. 日志管理
- 操作日志记录
- 错误日志收集
- 审计日志保存
- 日志分析工具

## 部署架构

### 1. 开发环境
- 本地开发服务器
- 热重载支持
- 调试工具集成
- 模拟数据支持

### 2. 生产环境
- CDN静态资源分发
- 数据库主从复制
- 负载均衡配置
- 自动备份恢复

## 后续开发计划

### 第一阶段：基础功能完善 (当前阶段)
- [x] 用户认证系统
- [x] 订单管理功能
- [x] 支付流程实现
- [x] 实时聊天功能

### 第二阶段：管理后台开发
- [ ] 管理员权限系统
- [ ] 数据统计分析
- [ ] 系统配置管理
- [ ] 用户行为监控

### 第三阶段：高级功能
- [ ] 智能推荐算法
- [ ] 信用评价体系
- [ ] 多渠道支付集成
- [ ] 移动端优化

## 总结

当前快递代领平台后端功能已经实现了核心的业务流程，包括用户管理、订单处理、支付系统和实时通信。系统采用现代化的技术架构，具有良好的扩展性和维护性。

后续开发重点应放在管理后台功能的完善、系统性能的优化以及安全机制的加强上。通过分阶段实施开发计划，可以确保系统的稳定性和功能的完整性。